<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" class="x-admin-sm" lang="en">
<head th:fragment="head">
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="icon" type="image/x-icon" th:href="@{/x-admin/images/icon.svg}"/>
    <link rel="shortcut icon" th:href="@{/x-admin/images/bg.png}"/>
    <link rel="shortcut icon" th:href="@{/x-admin/images/aiwrap.png}"/>
    <link rel="stylesheet" th:href="@{/x-admin/css/login.css}"/>
    <link rel="stylesheet" th:href="@{/x-admin/css/theme1.css}"/>
    <link rel="stylesheet" th:href="@{/x-admin/css/theme2.css}"/>
    <link rel="stylesheet" th:href="@{/x-admin/css/theme3.css}"/>
    <link rel="stylesheet" th:href="@{/x-admin/css/theme4.css}"/>
    <link rel="stylesheet" th:href="@{/x-admin/css/theme5.css}"/>
    <link rel="stylesheet" th:href="@{/x-admin/css/font.css}">
    <link rel="stylesheet" th:href="@{/x-admin/css/xadmin.css}">
    <link rel="stylesheet" th:href="@{/x-admin/css/theme5.css}">
    <script th:src="@{/x-admin/lib/layui/layui.js}" charset="utf-8"></script>
    <script type="text/javascript" th:src="@{/x-admin/js/xadmin.js}"></script>
    <script th:src="@{/x-admin/js/jquery.min.js}" type="text/javascript"></script>
    <title>welcome</title>
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<body class="login-bg">
<img th:src="@{/x-admin/images/bg.png}">
<div class="login layui-anim layui-anim-up">
    <div class="message">Just you-管理登录</div>
    <div id="darkbannerwrap"></div>

    <form method="post" class="layui-form" th:action="@{/login}">
        <label>
            <input name="username" id="username" placeholder="用户名" type="text" class="layui-input">
        </label>
        <hr class="hr15">
        <label>
            <input name="password" placeholder="密码" type="password" class="layui-input">
        </label>
        <hr class="hr15">
        <input value="登录" style="width:100%;" type="submit">
        <hr class="hr20">
    </form>
</div>

<!-- 底部结束 -->
<script>
    var lockReconnect = false;//避免重复连接
    var wsUrl = "ws://127.0.0.1:8089/justyou/websocket/api/1";

    var websocket;
    var tt;
    createWebSocket();

    function createWebSocket() {
        try {
            websocket = new WebSocket(wsUrl);
            init();
        } catch (e) {
            console.log('catch' + e);
            reconnect(wsUrl);
        }
    }

    function init() {
        websocket.onclose = function () {
            console.log('链接关闭');
            reconnect(wsUrl);
        };
        websocket.onerror = function () {
            console.log('发生异常了');
            reconnect(wsUrl);
        };
        websocket.onopen = function () {
            //心跳检测重置
            heartCheck.start();
        };
        websocket.onmessage = function (event) {
            console.log(event.data);
            heartCheck.start();

        }
    }

    window.onbeforeunload = function () {
        websocket.close();
    }

    var lockReconnect = false;//避免重复连接
    function reconnect(url) {
        if (lockReconnect) {
            return;
        }
        lockReconnect = true;
        //没连接上会一直重连，设置延迟避免请求过多
        tt && clearTimeout(tt);
        tt = setTimeout(function () {
            createWebSocket(url);
            lockReconnect = false;
        }, 4000);
    }

    //心跳检测
    var heartCheck = {
        timeout: 60000,
        timeoutObj: null,
        serverTimeoutObj: null,
        start: function () {
            var self = this;
            this.timeoutObj && clearTimeout(this.timeoutObj);
            this.serverTimeoutObj && clearTimeout(this.serverTimeoutObj);
            this.timeoutObj = setTimeout(function () {
                //这里发送一个心跳，后端收到后，返回一个心跳消息，
                //onmessage拿到返回的心跳就说明连接正常
                websocket.send("123456789");
                // self.serverTimeoutObj = setTimeout(function () {
                //     console.log(111);
                //     console.log(websocket);
                //     websocket.close();
                //     createWebSocket();
                // }, self.timeout);

            }, this.timeout)
        }
    }

    //百度统计可去掉
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?b393d153aeb26b46e9431fabaf0f6190";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
</body>
</html>